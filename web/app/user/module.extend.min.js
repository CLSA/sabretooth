define(["appointment"].reduce(function(list,name){return list.concat(cenozoApp.module(name).getRequiredFiles())},[cenozoApp.module("user").getFileUrl("module.js")]),function(){"use strict";var module=cenozoApp.module("user");if(angular.isDefined(module.actions.calendar)){module.addExtraOperation("view",{title:"Calendar",operation:async function($state,model){await $state.go("user.calendar",{identifier:model.viewModel.record.getIdentifier()})}})}function getEventFromAppointment(appointment,timezone){var event={};if(angular.isUndefined(appointment.subject))appointment.subject="appointment";if(angular.isDefined(appointment.start)&&angular.isDefined(appointment.end)){event=appointment}else{var date=moment(appointment.start_datetime);var offset=moment.tz.zone(timezone).offset(date.unix());if(date.tz(timezone).isDST())offset+=-60;event={title:(angular.isDefined(appointment.uid)?appointment.uid:"new appointment")+(angular.isDefined(appointment.qnaire_rank)?" ("+appointment.qnaire_rank+")":""),getIdentifier:function(){return appointment.getIdentifier()},start:moment(appointment.start_datetime).subtract(offset,"minutes"),end:moment(appointment.end_datetime).subtract(offset,"minutes")}}angular.extend(event,{title:event.title.replace(/\nfor .+$/,"")});return event}cenozo.providers.directive("cnUserCalendar",["CnUserModelFactory","CnUserCalendarFactory",function(CnUserModelFactory,CnUserCalendarFactory){return{templateUrl:cenozoApp.getFileUrl("user","calendar.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model)){$scope.model=CnUserModelFactory.instance();$scope.model.calendarModel=CnUserCalendarFactory.instance($scope.model)}if(angular.isDefined($scope.model.calendarModel))$scope.model.calendarModel.heading="Personal Calendar"}}}]);cenozo.providers.factory("CnUserCalendarFactory",["CnBaseCalendarFactory","CnAppointmentModelFactory","CnSession","$state",function(CnBaseCalendarFactory,CnAppointmentModelFactory,CnSession,$state){var object=function(parentModel){CnBaseCalendarFactory.construct(this,parentModel);if(angular.isUndefined(this.settings.views))this.settings.views={};if(angular.isUndefined(this.settings.views.month))this.settings.views.month={};this.settings.views.month.displayEventEnd=true;var appointmentModule=cenozoApp.module("appointment");var appointmentModel=null;var getViewEnabled=parentModel.getViewEnabled;parentModel.getViewEnabled=function(){return true};parentModel.getViewEnabled=getViewEnabled;delete this.settings.dayClick;this.settings.eventClick=async function(record){angular.element(this).popover("hide");await this.initPromise;if(angular.isUndefined(record.subject)){console.warn("Clicked on personal calendar event which is not an appointment.")}else if(appointmentModel.getViewEnabled()){if("appointment"==record.subject&&angular.isDefined(appointmentModule.actions.view))await $state.go(record.subject+".view",{identifier:record.getIdentifier()})}};angular.extend(this,{initPromise:null,onCalendar:async function(replace,minDate,maxDate,ignoreParent){var loadMinDate=this.getLoadMinDate(replace,minDate);var loadMaxDate=this.getLoadMaxDate(replace,maxDate);await this.initPromise;await appointmentModel.calendarModel.onCalendar(replace,minDate,maxDate,ignoreParent);this.cache=appointmentModel.calendarModel.cache;this.cache.forEach(function(item,index,array){array[index]=getEventFromAppointment(item,CnSession.user.timezone)})}});var self=this;async function init(){self.initPromise=await parentModel.viewModel.onView();appointmentModel=CnAppointmentModelFactory.forUser(parentModel.viewModel.record)}init()};return{instance:function(parentModel){return new object(parentModel)}}}])});
